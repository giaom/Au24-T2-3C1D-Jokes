@{
    ViewData["Title"] = "Home Page";
}

<div class="text-center">
    <h1 class="display-4">Welcome to the Home Page!</h1>

    <form id="jokeForm">
        @Html.AntiForgeryToken()
        <div class="form-group">
            <label for="Text">Joke Text</label>
            <input type="text" class="form-control" id="Text" name="Text" required />
        </div>

        <div class="form-group">
            <label for="Author">Author</label>
            <input type="text" class="form-control" id="Author" name="Author" required />
        </div>

        <button type="submit" class="btn btn-primary">Submit</button>
    </form>

    @if (!string.IsNullOrEmpty(ViewData["SuccessMessage"] as string))
    {
        <div class="alert alert-success mt-3">
            @ViewData["SuccessMessage"]
        </div>
    }

    <!-- Displaying the jokes with delete option -->
    <div id="jokesList" class="mt-5">
        <!-- Jokes will be appended here dynamically -->
    </div>

    <!-- Find Joke by ID -->
    <div class="mt-5">
        <form id="findJokeForm">
            <div class="form-group">
                <label for="jokeIdToFind">Joke ID to Find</label>
                <input type="text" class="form-control" id="jokeIdToFind" name="jokeIdToFind"
                    placeholder="Enter joke ID to find" required />
            </div>
            <button type="submit" class="btn btn-info">Find Joke</button>
        </form>

        <div id="foundJoke" class="mt-3">
            <!-- Found joke will be displayed here -->
        </div>
    </div>
</div>

<form id="removeJokeForm" class="mb-5">
    <div class="form-group">
        <label for="jokeIdToRemove">Joke ID to Remove</label>
        <input type="text" class="form-control" id="jokeIdToRemove" name="jokeIdToRemove"
            placeholder="Enter joke ID to remove" required />
    </div>
    <button type="submit" class="btn btn-danger">Remove Joke</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Function to fetch all jokes and display them
    function loadJokes() {
        $.ajax({
            url: '/api/jokes',  // Endpoint to fetch all jokes
            type: 'GET',
            success: function (response) {
                $('#jokesList').empty();  // Clear existing jokes
                response.forEach(function (joke) {
                    $('#jokesList').append(`
                        <div class="joke-item" data-id="${joke.id}">
                            <p><strong>${joke.text}</strong></p>
                            <p><em>by ${joke.author}</em></p>
                            <button class="btn btn-danger delete-btn">Remove</button>
                        </div>
                    `);
                });
            },
            error: function () {
                alert('Error fetching jokes');
            }
        });
    }

    // Submit the joke form (POST request to add a new joke)
    $('#jokeForm').submit(function (e) {
        e.preventDefault(); // Prevent default form submission

        var jokeData = {
            Text: $('#Text').val(),
            Author: $('#Author').val()
        };

        $.ajax({
            url: '/api/jokes',  // Correct URL to your API endpoint
            type: 'POST',
            data: JSON.stringify(jokeData),
            contentType: 'application/json', // Send data as JSON
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() // For CSRF protection
            },
            success: function (response) {
                alert('Joke added successfully');
                loadJokes(); // Reload the jokes list after adding
                $('#jokeForm')[0].reset(); // Reset the form
            },
            error: function () {
                alert('Error adding joke');
            }
        });
    });

    // Delete a joke (remove it from the list and the database) when the "Remove" button is clicked
    $(document).on('click', '.delete-btn', function () {
        var jokeId = $(this).closest('.joke-item').data('id');

        $.ajax({
            url: '/api/jokes/remove/' + jokeId,  // Delete endpoint with joke ID
            type: 'DELETE',
            success: function () {
                alert('Joke removed successfully');
                loadJokes(); // Reload the jokes list after removal
            },
            error: function () {
                alert('Error removing joke');
            }
        });
    });

    // Handle the removal of a joke by ID entered in the form
    $('#removeJokeForm').submit(function (e) {
        e.preventDefault(); // Prevent form submission

        var jokeId = $('#jokeIdToRemove').val(); // Get the entered joke ID

        if (!jokeId) {
            alert('Please enter a joke ID');
            return;
        }

        $.ajax({
            url: '/api/jokes/remove/' + jokeId,  // Delete endpoint with joke ID
            type: 'DELETE',
            success: function () {
                alert('Joke removed successfully');
                loadJokes(); // Reload the jokes list after removal
            },
            error: function () {
                alert('Error removing joke');
            }
        });
    });

    // Handle the find joke by ID form submission
    $('#findJokeForm').submit(function (e) {
        e.preventDefault(); // Prevent form submission

        var jokeId = $('#jokeIdToFind').val(); // Get the entered joke ID

        if (!jokeId) {
            alert('Please enter a joke ID');
            return;
        }

        $.ajax({
            url: '/api/jokes/' + jokeId,  // Get joke by ID
            type: 'GET',
            success: function (response) {
                $('#foundJoke').html(`
                    <div class="alert alert-info">
                        <p><strong>${response.text}</strong></p>
                        <p><em>by ${response.author}</em></p>
                    </div>
                `);
            },
            error: function () {
                $('#foundJoke').html('<div class="alert alert-danger">Joke not found.</div>');
            }
        });
    });

    // Initial load of jokes when the page is ready
    $(document).ready(function () {
        loadJokes(); // Load jokes on page load
    });
</script>
